<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room</title>
    <script src="http://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: #4B5563 transparent; /* Firefox */
        }

        /* Webkit browsers */
        ::-webkit-scrollbar {
            width: 8px; /* æ»šåŠ¨æ¡å®½åº¦ */
        }

        ::-webkit-scrollbar-thumb {
            background-color: #4B5563; /* æ»šåŠ¨æ¡é¢œè‰² */
            border-radius: 10px; /* åœ†è§’ */
        }

        ::-webkit-scrollbar-track {
            background: transparent; /* æ»šåŠ¨æ¡èƒŒæ™¯ */
        }

        .chat-container {
            max-width: 600px; /* å›ºå®šèŠå¤©åŒºåŸŸå®½åº¦ */
            width: 100%; /* ç¡®ä¿å…¶åœ¨å°å±å¹•ä¸Šè‡ªé€‚åº” */
            margin: 0 auto; /* å±…ä¸­å¯¹é½ */
        }

        .scrollable {
            max-height: 85vh; /* é™åˆ¶èŠå¤©åŒºåŸŸé«˜åº¦ï¼Œä»¥é€‚åº”ä¸åŒå±å¹• */
            overflow-y: auto; /* å…è®¸å‚ç›´æ»šåŠ¨ */
            border: 1px solid #4B5563; /* æ·»åŠ è¾¹æ¡† */
            border-radius: 8px; /* åœ†è§’ */
        }

        .chat-bubble {
            display: inline-block;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 55%; /* æ§åˆ¶æ¶ˆæ¯æ°”æ³¡æœ€å¤§å®½åº¦ */
            word-wrap: break-word;
        }

        .message-container {
            display: flex; /* ä½¿ç”¨ flexbox å¸ƒå±€ */
            align-items: flex-start; /* å‚ç›´å¯¹é½å¤´åƒå’Œæ¶ˆæ¯æ°”æ³¡ */
            margin-bottom: 10px;
        }

        .my-message-container {
            flex-direction: row-reverse; /* è‡ªå·±çš„æ¶ˆæ¯åå‘æ’åˆ—ï¼Œå¤´åƒåœ¨å³ï¼Œæ¶ˆæ¯åœ¨å·¦ */
        }

        .their-message-container {
            flex-direction: row; /* å…¶ä»–ç”¨æˆ·çš„æ¶ˆæ¯æ­£å¸¸æ’åˆ—ï¼Œå¤´åƒåœ¨å·¦ï¼Œæ¶ˆæ¯åœ¨å³ */
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px; /* å¤´åƒä¸æ¶ˆæ¯æ°”æ³¡ä¹‹é—´çš„å³è¾¹è· */
        }

        .my-message {
            background-color: #007AFF; /* è“è‰² */
            color: white;
            margin-right: 10px; /* ç¡®ä¿æ¶ˆæ¯æ°”æ³¡å’Œå¤´åƒä¹‹é—´æœ‰é—´è· */
        }

        .their-message {
            background-color: #E5E5EA; /* æ·¡ç°è‰² */
            color: black;
            margin-left: 10px; /* ç¡®ä¿æ¶ˆæ¯æ°”æ³¡å’Œå¤´åƒä¹‹é—´æœ‰é—´è· */
        }

        .username {
            font-weight: bold;
            color: #333; /* æ·±ç°è‰² */
        }

        #in {
            border-radius: 20px;
        }

        #suggestions {
            position: relative;
            z-index: 1;
        }

        .suggestion-item {
            padding: 5px 10px;
        }

        .suggestion-item:hover {
            background-color: #333;
        }


        @media (max-width: 640px) {
            .chat-bubble {
                max-width: 55%; /* ç§»åŠ¨ç«¯æœ€å¤§å®½åº¦ */
            }
        }
    </style>
</head>

<body class="bg-gray-900 text-white font-mono h-screen flex flex-col justify-between">
<button onclick="logout()">ç™»å‡º</button>
<div class="chat-container">
    <div class="scrollable p-4" id="scrollable">
        <div id="out" class="space-y-2 mb-4">
            <!-- æ¶ˆæ¯ä¼šåŠ¨æ€æ·»åŠ åœ¨è¿™é‡Œ -->
        </div>
    </div>
    <div id="suggestions" class="p-4 hidden bg-gray-800 border border-gray-700 rounded">
        <div class="suggestion-item cursor-pointer">ğŸ¤–AIåŠ©æ‰‹</div>
    </div>
    <div class="p-4">
        <input id="in" placeholder="å›è½¦å‘é€" class="w-full p-2 bg-gray-800 border border-gray-700 rounded">
    </div>
</div>

<script>
    let lastMessageTime = null;
    const defaultAvatar = "https://api.7trees.cn/avatar";
    const socket = io(); // åˆ›å»º Socket.IO è¿æ¥

    socket.on('new_message', function (message) {
        addMessage(message); // æ¥æ”¶æ–°æ¶ˆæ¯ï¼Œæ·»åŠ åˆ°æ¶ˆæ¯æ¡†
        const scrollable = document.getElementById('scrollable');
        setTimeout(() => {
            smoothScrollToBottom(scrollable); // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        }, 200); // è°ƒæ•´å»¶è¿Ÿæ—¶é—´
    });

    function easeOutQuad(t) {
        return t * (2 - t); // äºŒæ¬¡è´å¡å°”æ›²çº¿ç¼“åŠ¨å‡½æ•°
    }

    function smoothScrollToBottom(element) {
        const targetScrollTop = element.scrollHeight; // æ»šåŠ¨æ¡ç›®æ ‡ä½ç½®
        const duration = 400; // åŠ¨ç”»æŒç»­æ—¶é—´
        const startScrollTop = element.scrollTop; // å½“å‰æ»šåŠ¨ä½ç½®
        const distance = targetScrollTop - startScrollTop; // æ»šåŠ¨è·ç¦»
        let startTime = null; // å¼€å§‹æ—¶é—´

        function animation(currentTime) {
            if (!startTime) startTime = currentTime; // åˆå§‹åŒ–å¼€å§‹æ—¶é—´
            const timeElapsed = currentTime - startTime; // å·²è¿‡æ—¶é—´
            const t = Math.min(timeElapsed / duration, 1); // è¿›åº¦æ§åˆ¶
            const ease = easeOutQuad(t); // åº”ç”¨ç¼“åŠ¨è®¡ç®—
            element.scrollTop = startScrollTop + distance * ease; // æ›´æ–°æ»šåŠ¨ä½ç½®

            if (t < 1) requestAnimationFrame(animation); // ç»§ç»­åŠ¨ç”»
        }

        requestAnimationFrame(animation); // å¯åŠ¨åŠ¨ç”»
    }

    function addMessage(message) {
        var out = document.getElementById('out');
        let currentTime = new Date();

        // å½“å‰æ—¶é—´æ˜¯å¦ä¸ä¸Šæ¡æ¶ˆæ¯é—´éš”è¶…è¿‡1åˆ†é’Ÿ
        if (lastMessageTime && (currentTime - lastMessageTime) > 60000) {
            var timeSeparator = `<div class="text-center text-gray-500 my-2">--- ${formatDate(currentTime)} ---</div>`;
            out.innerHTML += timeSeparator; // å°†åˆ†éš”æ—¶é—´æ’å…¥åˆ°å®¹å™¨åº•éƒ¨
        }

        function indexOfThirdColon(message) {
            let index = -1;
            for (let i = 0; i < 3; i++) {
                index = message.indexOf(':', index + 1);
                if (index === -1) {
                    return -1; // å¦‚æœæœªæ‰¾åˆ°ç¬¬ä¸‰ä¸ªå†’å·ï¼Œåˆ™è¿”å› -1
                }
            }
            return index; // è¿”å›ç¬¬ä¸‰ä¸ªå†’å·çš„ä½ç½®
        }

        const thirdColonIndex = indexOfThirdColon(message);

        // ä»æ¶ˆæ¯ä¸­æå–ç”¨æˆ·åå’Œå†…å®¹
        const indexOfColon = thirdColonIndex;
        if (indexOfColon >= 0) {
            const username = message.substring(11, indexOfColon).trim(); // æå–ç”¨æˆ·å
            const userMessage = message.substring(indexOfColon + 1).trim(); // æå–æ¶ˆæ¯å†…å®¹

            let messageHTML = '';

            // æ ¹æ®ç”¨æˆ·åæ„å»ºæ¶ˆæ¯å®¹å™¨
            if (username === '{{ user }}') { // å¦‚æœç”¨æˆ·åæ˜¯è‡ªå·±
                messageHTML = `
                <div class="message-container my-message-container">
                    <img src="${defaultAvatar}?${username}" alt="Avatar" class="avatar">
                    <div class="chat-bubble my-message">
                        <div class="username">${username}ï¼ˆæˆ‘ï¼‰</div>
                        <div>${userMessage}</div>
                    </div>
                </div>`;
            } else if (username === 'ğŸ¤–AIåŠ©æ‰‹') { // å¦‚æœç”¨æˆ·åæ˜¯ ğŸ¤–AIåŠ©æ‰‹
                messageHTML = `
                <div class="message-container their-message-container">
                    <img src="${defaultAvatar}?${username}" alt="Avatar" class="avatar">
                    <div class="chat-bubble their-message">
                        <div class="username">${username}</div>
                        <div>${marked.parse(userMessage)}</div> <!-- ä½¿ç”¨ marked.parse æ¸²æŸ“æ¶ˆæ¯å†…å®¹ -->
                    </div>
                </div>`;
            } else {
                messageHTML = `
                <div class="message-container their-message-container">
                    <img src="${defaultAvatar}?${username}" alt="Avatar" class="avatar">
                    <div class="chat-bubble their-message">
                        <div class="username">${username}</div>
                        ${userMessage}
                    </div>
                </div>`;
            }

            out.innerHTML += messageHTML; // å°†æ–°æ¶ˆæ¯æ’å…¥åˆ°åº•éƒ¨
            lastMessageTime = currentTime;  // æ›´æ–°æœ€åæ¶ˆæ¯æ—¶é—´
        }
    }

    function formatDate(date) {
        return `${date.getHours()}:${date.getMinutes() < 10 ? '0' : ''}${date.getMinutes()}`;
    }

    $('#in').keyup(function (e) {
        const suggestions = $('#suggestions');
        const suggestionsItem = suggestions.find('.suggestion-item');
        const inputValue = $(this).val();

        if (e.keyCode === 13) { // Enter é”®
            const message = inputValue;
            if (message) {
                socket.emit('send_message', message); // ä½¿ç”¨ Socket.IO å‘é€æ¶ˆæ¯
                addMessage(`yue: ${message}`); // ä¸´æ—¶æ·»åŠ æ¶ˆæ¯ä»¥ä¿æŒè§†è§‰ä¸€è‡´æ€§
                $(this).val('');
                suggestions.hide(); // éšè—é€‰æ‹©æ 
            }
        } else if (inputValue.endsWith('/')) {
            suggestions.show(); // æ˜¾ç¤ºé€‰æ‹©æ 
        } else {
            suggestions.hide(); // éšè—é€‰æ‹©æ 
        }

        // å¤„ç†é€‰æ‹©æ ç‚¹å‡»äº‹ä»¶
        suggestionsItem.off('click').on('click', function () {
            $(this).closest('#suggestions').hide();
            $('#in').val(inputValue.replace(/\/$/, '@ai '));
            $('#in').focus();
        });
    });

    function logout() {
        // ç¡®è®¤ç”¨æˆ·æ˜¯å¦æƒ³è¦ç™»å‡º
        if (confirm('ç¡®è®¤è¦ç™»å‡ºå—ï¼Ÿ')) {
            // æ¸…é™¤æœ¬åœ°å­˜å‚¨
            localStorage.removeItem('historyRequested');
            // é‡å®šå‘åˆ°ç™»å‡ºé¡µé¢
            window.location.href = '/logout';
        }
    }

</script>
<script>
    var historyMessagePacket = io();

    // æ£€æŸ¥æ˜¯å¦å·²ç»è¯·æ±‚è¿‡å†å²æ¶ˆæ¯
    if (!localStorage.getItem('historyRequested')) {
        // è¿æ¥æˆåŠŸåè¯·æ±‚å†å²æ¶ˆæ¯
        historyMessagePacket.on('connect', function () {
            historyMessagePacket.emit('get_history');
            // è®¾ç½®æ ‡å¿—ï¼Œè¡¨ç¤ºå†å²æ¶ˆæ¯å·²ç»è¯·æ±‚è¿‡
            localStorage.setItem('historyRequested', 'true');
        });
    }

    // æ¥æ”¶å†å²æ¶ˆæ¯å¤„ç†
    historyMessagePacket.on('history_messages', function (messages) {
        messages.forEach(function (msg) {
            return addMessage(msg);
        });
    });
</script>

</body>

</html>
