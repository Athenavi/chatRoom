<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room</title>
    <script src="http://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.min.js"></script>
    <!-- 引入 Socket.IO -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: #4B5563 transparent; /* Firefox */
        }

        /* Webkit browsers */
        ::-webkit-scrollbar {
            width: 8px; /* 滚动条宽度 */
        }

        ::-webkit-scrollbar-thumb {
            background-color: #4B5563; /* 滚动条颜色 */
            border-radius: 10px; /* 圆角 */
        }

        ::-webkit-scrollbar-track {
            background: transparent; /* 滚动条背景 */
        }

        .chat-container {
            max-width: 600px; /* 固定聊天区域宽度 */
            width: 100%; /* 确保其在小屏幕上自适应 */
            margin: 0 auto; /* 居中对齐 */
        }

        .scrollable {
            max-height: 85vh; /* 限制聊天区域高度，以适应不同屏幕 */
            overflow-y: auto; /* 允许垂直滚动 */
            border: 1px solid #4B5563; /* 添加边框 */
            border-radius: 8px; /* 圆角 */
        }

        .chat-bubble {
            display: inline-block;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 55%; /* 控制消息气泡最大宽度 */
            word-wrap: break-word;
        }

        .message-container {
            display: flex; /* 使用 flexbox 布局 */
            align-items: flex-start; /* 垂直对齐头像和消息气泡 */
            margin-bottom: 10px;
        }

        .my-message-container {
            justify-content: flex-end; /* 自己的消息右对齐 */
        }

        .their-message-container {
            justify-content: flex-start; /* 其他用户的消息左对齐 */
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px; /* 头像与消息气泡之间的右边距 */
        }

        .my-message {
            background-color: #007AFF; /* 蓝色 */
            color: white;
        }

        .their-message {
            background-color: #E5E5EA; /* 淡灰色 */
            color: black;
        }

        .username {
            font-weight: bold;
            color: #333; /* 深灰色 */
        }

        #in {
            border-radius: 20px;
        }

        @media (max-width: 640px) {
            .chat-bubble {
                max-width: 55%; /* 移动端最大宽度 */
            }
        }
    </style>
</head>

<body class="bg-gray-900 text-white font-mono h-screen flex flex-col justify-between">
<div class="chat-container">
    <div class="scrollable p-4" id="scrollable">
        <div id="out" class="space-y-2 mb-4"></div>
    </div>
    <div class="p-4">
        <input id="in" placeholder="回车发送" class="w-full p-2 bg-gray-800 border border-gray-700 rounded">
    </div>
</div>

<script>
    let lastMessageTime = null;
    const defaultAvatar = "https://api.7trees.cn/avatar";
    const socket = io(); // 创建 Socket.IO 连接

    socket.on('new_message', function (message) {
        addMessage(message); // 接收新消息，添加到消息框
        const scrollable = document.getElementById('scrollable');
        setTimeout(() => {
            smoothScrollToBottom(scrollable); // 自动滚动到底部
        }, 200); // 调整延迟时间
    });

    function easeOutQuad(t) {
        return t * (2 - t); // 二次贝塞尔曲线缓动函数
    }

    function smoothScrollToBottom(element) {
        const targetScrollTop = element.scrollHeight; // 滚动条目标位置
        const duration = 400; // 动画持续时间
        const startScrollTop = element.scrollTop; // 当前滚动位置
        const distance = targetScrollTop - startScrollTop; // 滚动距离
        let startTime = null; // 开始时间

        function animation(currentTime) {
            if (!startTime) startTime = currentTime; // 初始化开始时间
            const timeElapsed = currentTime - startTime; // 已过时间
            const t = Math.min(timeElapsed / duration, 1); // 进度控制
            const ease = easeOutQuad(t); // 应用缓动计算
            element.scrollTop = startScrollTop + distance * ease; // 更新滚动位置

            if (t < 1) requestAnimationFrame(animation); // 继续动画
        }

        requestAnimationFrame(animation); // 启动动画
    }

    function addMessage(message) {
        var out = document.getElementById('out');
        let currentTime = new Date();

        // 当前时间是否与上条消息间隔超过1分钟
        if (lastMessageTime && (currentTime - lastMessageTime) > 60000) {
            var timeSeparator = `<div class="text-center text-gray-500 my-2">--- ${formatDate(currentTime)} ---</div>`;
            out.innerHTML += timeSeparator; // 将分隔时间插入到容器底部
        }

        function indexOfThirdColon(message) {
            let index = -1;
            for (let i = 0; i < 3; i++) {
                index = message.indexOf(':', index + 1);
                if (index === -1) {
                    return -1; // 如果未找到第三个冒号，则返回 -1
                }
            }
            return index; // 返回第三个冒号的位置
        }

        const thirdColonIndex = indexOfThirdColon(message);

        // 从消息中提取用户名和内容
        const indexOfColon = thirdColonIndex;
        if (indexOfColon >= 0) {
            const username = message.substring(11, indexOfColon).trim(); // 提取用户名
            const userMessage = message.substring(indexOfColon + 1).trim(); // 提取消息内容

            let messageHTML = '';

            // 根据用户名构建消息容器
            if (username === '{{ user }}') { // 如果用户名是自己
                messageHTML = `
                    <div class="message-container my-message-container">
                        <div>
                            <div class="username">${username}（我）</div>
                            <div class="chat-bubble my-message">${userMessage}</div>
                        </div>
                        <img src="${defaultAvatar}?${username}" alt="Avatar" class="avatar">
                    </div>`;
            } else {
                messageHTML = `
                    <div class="message-container">
                        <img src="${defaultAvatar}?${username}" alt="Avatar" class="avatar">
                        <div>
                            <div class="username">${username}</div>
                            <div class="chat-bubble their-message">${userMessage}</div>
                        </div>
                    </div>`;
            }

            out.innerHTML += messageHTML; // 将新消息插入到底部
            lastMessageTime = currentTime;  // 更新最后消息时间
        }
    }

    function formatDate(date) {
        return `${date.getHours()}:${date.getMinutes() < 10 ? '0' : ''}${date.getMinutes()}`;
    }

    $('#in').keyup(function (e) {
        if (e.keyCode == 13) {
            var message = $(this).val();
            if (message) {
                socket.emit('send_message', message); // 使用 Socket.IO 发送消息
                addMessage(`{{ user }}: ${message}`); // 临时添加消息以保持视觉一致性
                $(this).val('');
            }
        }
    });
</script>
</body>

</html>